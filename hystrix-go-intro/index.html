<!doctype html><html lang=en-us><head><title>Circuit breaking using hystrix-go | Marcus Olsson</title><link rel=stylesheet href=/scss/main.a35e8c8e54f9dc5983223f83654e0c29c0e576a3b4f17c5d5a5b12bd440e2d07d9894ed93ea297c8900b924daf6469b184b2fc04a93f6e15930cc68dba017c41.css integrity="sha512-o16MjlT53FmDIj+DZU4MKcDldqO08XxdWlsSvUQOLQfZiU7ZPqKXyJALkk2vZGmxhLL8BKk/bhWTDMaNugF8QQ=="><meta charset=utf-8><meta data-rh=true name=viewport content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=1"><meta name=author content="Marcus Olsson"><meta name=description content="So we have been looking at adding circuit breaking to our services at my current client as part of making them more resilient. We used the fantastic hystrix-go package and since I could not really find any other examples other than the ones in the tests, I thought I might share one."><meta name=twitter:card content="summary"><meta name=og:title content="Circuit breaking using hystrix-go | Marcus Olsson"><meta name=og:description content="So we have been looking at adding circuit breaking to our services at my current client as part of making them more resilient. We used the fantastic hystrix-go package and since I could not really find any other examples other than the ones in the tests, I thought I might share one."><meta name=og:type content="article"><meta name=og:url content="https://marcus.se.net/hystrix-go-intro/"><meta name=og:image content="https://marcus.se.net/images/avatar_hu79b10322fccaa7c63e12808baa2d9ea4_209492_512x512_resize_box_3.png"><link rel=icon sizes=32x32 type=image/png href=/images/avatar_hu79b10322fccaa7c63e12808baa2d9ea4_209492_32x32_resize_box_3.png><link rel=apple-touch-icon sizes=180x180 type=image/png href=/images/avatar_hu79b10322fccaa7c63e12808baa2d9ea4_209492_180x180_resize_box_3.png><link rel=“canonical” href=https://marcus.se.net/hystrix-go-intro/><link rel=prefetch href=/><link rel=prefetch href=/writing/><link rel=prefetch href=/speaking/><link rel=prefetch href=/projects/><script defer data-domain=marcus.se.net src=https://plausible.io/js/plausible.js></script>
<script src=/js/main.min.4a7db9712038f8d184460fcb634d3df46b2835119391ec11d1d951cf8250ed2a5b0cb946512a05b46f7c15ec55229bf36e849ea280bc3da14f8ee4f59031a5d7.js integrity="sha512-Sn25cSA4+NGERg/LY0099GsoNRGTkewR0dlRz4JQ7SpbDLlGUSoFtG98FexVIpvzboSeooC8PaFPjuT1kDGl1w=="></script></head><body><a class=skip-link href=#main>Skip to content</a><header class=header><div class=brand><a class=brand__title href=/>Marcus Olsson</a></div><nav class=main-nav aria-label=Main><ul><li><a class=main-nav__link href=/writing>Writing</a></li><li><a class=main-nav__link href=/speaking>Speaking</a></li><li><a class=main-nav__link href=/projects>Projects</a></li></ul></nav></header><div class=container><main id=main><section class=text-block><div class=flex><article style=flex-grow:1><header class=section__header><h1>Circuit breaking using hystrix-go</h1><time datetime=2015-05-09 class=publication-date>May 9, 2015</time></header><section><p>For those of you who are not familiar with circuit breaking, imagine that you are developing a service which in turn makes requests to an external service. Regardless of whether that service is within your control or not, you need to consider what would happen when it becomes unavailable, because it most definitely will.</p><p>If you are not careful, your precious service will grind to a halt while waiting for your growing number of requests to complete. Even worse, if other applications are depending on your service, the error may propagate until the entire system is down. One way of preventing this disaster is to stop throwing requests at the poor, broken service for a while until it is up and running again. Much like <em>breaking a circuit</em>, get it? There is no shortage on articles explaining circuit breakers, so I will leave it there and focus on how to implement it using the <code>hystrix-go</code> package.</p><p>Using the <code>hystrix-go</code> package is really quite simple, the <code>hystrix.Go()</code> function is really all you need. The first argument is a string that allows you to configure the circuit breaker, the second argument is a function where you typically would do the request to another sub-system. Finally, the last argument is a fallback function that allows you to deal with errors.</p><p>The documentation describes two ways of using the <code>hystrix.Go()</code> function. Firstly, by using a fallback function you can handle the errors asynchronously:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>hystrix.<span style=color:#50fa7b>Go</span>(<span style=color:#f1fa8c>&#34;my_command&#34;</span>, <span style=color:#8be9fd;font-style:italic>func</span>() <span style=color:#8be9fd>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// talk to other services
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span>}, <span style=color:#8be9fd;font-style:italic>func</span>(err <span style=color:#8be9fd>error</span>) <span style=color:#8be9fd>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// do this when services are down
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>Typically though, in our case, we depend on the output from the other service before we can send a response back to our users. Which is why we have only used the second example from the documentation so far, which I will demonstrate with a tiny web service. This particular web service depends on an external service to tell us whether it is <em>hammer time</em> or not.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff79c6>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#f1fa8c>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f1fa8c>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f1fa8c>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f1fa8c>&#34;github.com/afex/hystrix-go/hystrix&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>main</span>() {
</span></span><span style=display:flex><span>	http.<span style=color:#50fa7b>HandleFunc</span>(<span style=color:#f1fa8c>&#34;/&#34;</span>, <span style=color:#8be9fd;font-style:italic>func</span>(w http.ResponseWriter, r <span style=color:#ff79c6>*</span>http.Request) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> r.Method <span style=color:#ff79c6>!=</span> <span style=color:#f1fa8c>&#34;GET&#34;</span> {
</span></span><span style=display:flex><span>			w.<span style=color:#50fa7b>WriteHeader</span>(http.StatusMethodNotAllowed)
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		resultChan <span style=color:#ff79c6>:=</span> <span style=color:#8be9fd;font-style:italic>make</span>(<span style=color:#8be9fd;font-style:italic>chan</span> <span style=color:#8be9fd>string</span>, <span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span>		errChan <span style=color:#ff79c6>:=</span> hystrix.<span style=color:#50fa7b>Go</span>(<span style=color:#f1fa8c>&#34;my_command&#34;</span>, <span style=color:#8be9fd;font-style:italic>func</span>() <span style=color:#8be9fd>error</span> {
</span></span><span style=display:flex><span>			resp, err <span style=color:#ff79c6>:=</span> http.<span style=color:#50fa7b>Get</span>(<span style=color:#f1fa8c>&#34;http://localhost:6061&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span> err
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>defer</span> r.Body.<span style=color:#50fa7b>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			b, err <span style=color:#ff79c6>:=</span> ioutil.<span style=color:#50fa7b>ReadAll</span>(resp.Body)
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span> err
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			resultChan <span style=color:#ff79c6>&lt;-</span> <span style=color:#8be9fd;font-style:italic>string</span>(b)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span>		}, <span style=color:#ff79c6>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Block until we have a result or an error.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>		<span style=color:#ff79c6>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> result <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>&lt;-</span>resultChan:
</span></span><span style=display:flex><span>			log.<span style=color:#50fa7b>Println</span>(<span style=color:#f1fa8c>&#34;success:&#34;</span>, result)
</span></span><span style=display:flex><span>			w.<span style=color:#50fa7b>WriteHeader</span>(http.StatusOK)
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> err <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>&lt;-</span>errChan:
</span></span><span style=display:flex><span>			log.<span style=color:#50fa7b>Println</span>(<span style=color:#f1fa8c>&#34;failure:&#34;</span>, err)
</span></span><span style=display:flex><span>			w.<span style=color:#50fa7b>WriteHeader</span>(http.StatusServiceUnavailable)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	http.<span style=color:#50fa7b>ListenAndServe</span>(<span style=color:#f1fa8c>&#34;:6060&#34;</span>, <span style=color:#ff79c6>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Since the <code>hystrix.Go()</code> function actually returns an error channel, we can use a <code>select</code> statement to block until we either get a result or an error. Now, as long as the hammer time service is healthy, we are all good but let us see what happens in the log when we shut down the external service. After a couple of requests (depending on your configuration) you will see this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>hystrix-go: opening circuit my_command
</span></span></code></pre></div><p>which means that hystrix has determined that something is wrong and as a result, opened the circuit. Any further requests will get the 503 Service Unavailable.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>failure: hystrix: circuit open
</span></span></code></pre></div><p>After a while we check whether the external service is back up or not.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>hystrix-go: allowing single test to possibly close circuit my_command
</span></span></code></pre></div><p>In this case, the service is still down so we will still get the <code>ErrCircuitOpen</code> error, but this time we turn the other service back on before the next test.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>failure: hystrix: circuit open
</span></span><span style=display:flex><span>hystrix-go: allowing single test to possibly close circuit my_command
</span></span><span style=display:flex><span>hystrix-go: closing circuit my_command
</span></span><span style=display:flex><span>success: Hammer Time
</span></span></code></pre></div><p>Finally, the external service is back online! From our users&rsquo; perspective, the service has been responding and telling them that &ldquo;unfortunately the service is unavailable at this point but please check back later, ok?&rdquo;.</p><p>Instead of peaks in your monitoring dashboards you now might have a flat line, which may fool you into thinking that it is just low traffic so make sure you monitor any requests that hits an open circuit. In fact, any changes to breaker states are valuable information about the health of you system and you should monitor accordingly.</p><p>We have been using hystrix-go in a couple of our services for a while now and so far I have been really impressed with it. I have to admit that there is something very satisfying about watching stable graphs even when external sub-systems are down. I encourage you to try it out!</p></section></article></div></section><script src=/js/main.min.4a7db9712038f8d184460fcb634d3df46b2835119391ec11d1d951cf8250ed2a5b0cb946512a05b46f7c15ec55229bf36e849ea280bc3da14f8ee4f59031a5d7.js integrity="sha512-Sn25cSA4+NGERg/LY0099GsoNRGTkewR0dlRz4JQ7SpbDLlGUSoFtG98FexVIpvzboSeooC8PaFPjuT1kDGl1w=="></script></main><footer class="footer text-block"><p id=bio class=text--disabled>I'm a Developer Advocate at
<a href=https://grafana.com>Grafana Labs</a>, who enjoys learning,
building, and teaching software.</p><div class=social><a class=social__icon href=https://github.com/marcusolsson aria-label=GitHub><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class=social__icon href=https://twitter.com/marcusolsson aria-label=Twitter><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Twitter icon</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958.0 002.163-2.723c-.951.555-2.005.959-3.127 1.184A4.92 4.92.0 0011.78 8.288C7.69 8.095 4.067 6.13 1.64 3.162A4.822 4.822.0 00.974 5.637c0 1.71.87 3.213 2.188 4.096A4.904 4.904.0 01.934 9.117v.06a4.923 4.923.0 003.946 4.827 4.996 4.996.0 01-2.212.085 4.936 4.936.0 004.604 3.417A9.867 9.867.0 011.17 19.611c-.39.0-.779-.023-1.17-.067a13.995 13.995.0 007.557 2.209c9.053.0 13.998-7.496 13.998-13.985.0-.21.0-.42-.015-.63A9.935 9.935.0 0024 4.59z"/></svg></a><a class=social__icon href=https://linkedin.com/in/marcusolsson1 aria-label=LinkedIn><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn icon</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></a></div><p class=text--disabled><small>&copy; Copyright 2022
<a href=https://marcus.se.net>Marcus Olsson</a></small></p></footer></div></body></html>